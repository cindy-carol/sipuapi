<div class="mobile-spacer d-block d-md-none" style="height: 3.5rem;"></div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<h1>Halaman Isi Jadwal Ujian</h1>
<%- include('../partials/card-mahasiswa') %>

<div class="row">
  <div class="col-lg-8">
    <h2>Jadwal Tersedia</h2>
    
    <div class="d-flex align-items-center gap-4 mt-3">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-success p-2" style="pointer-events:none;"></button>
        <span>Offline</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-info p-2" style="pointer-events:none;"></button>
        <span>Online</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button class="btn" style="background-color: #ffc107; pointer-events:none;"></button>
        <span>Menunggu Verifikasi</span>
      </div>
          
      <div class="d-flex align-items-center gap-2">
        <button class="btn p-2" style="background-color: #343a40; pointer-events:none;"></button>
        <button class="btn p-2" style="background-color: #adb5bd; pointer-events:none;"></button>
        <span>Jadwal Terisi</span>
      </div>
    </div>

    <%- include('../partials/calendar', {
        role: 'mahasiswa', 
        events: events,
        npm: npm,                
        myDosenIds: myDosenIds   
    }) %>  
  </div>

  <div class="col-lg-4">
    <h2>Isi Jadwal Ujian</h2>
    <div class="card">
      <div class="card-title">Isi Jadwal Ujian di sini</div>
      <div class="card-body">
        <form action="/mahasiswa/isi-jadwal" method="POST" id="formJadwal">
          <div class="form-group">

            <div id="alertError" class="alert alert-danger d-none p-2 mb-3" style="font-size: 0.9rem;"></div>

            <div class="row mb-3">
              <div class="fw-bold">Hari/Tanggal</div>
              <div class="">
                <input type="date" name="tanggal" class="form-control" 
                  value="<%= tanggal || '' %>" required>
              </div>
            </div>

            <div class="row mb-3">
              <div class="fw-bold">Waktu</div>
              <div class="">
                <input type="time" name="jamMulai" class="form-control" 
                  value="<%= jamMulai || '' %>" step="300" required>
              </div>
            </div>

            <div class="row mb-4">
              <div class="fw-bold">Pelaksanaan Ujian</div>
              <div class="text-black-50">
                <div class="d-flex gap-3 align-items-center">
                  
                  <div class="form-check mb-0 d-flex align-items-center">
                    <input class="form-check-input fs-6 me-2" type="radio" name="pelaksanaan" id="modeOffline" value="offline" 
                      <%= pelaksanaan === 'offline' ? 'checked' : '' %> required>
                    <i class="bi bi-building-fill pe-1 text-success"></i>
                    <span class="fs-5" id="labelOffline">Offline</span>
                  </div>

                  <div class="form-check mb-0 d-flex align-items-center">
                    <input class="form-check-input fs-6 me-2" type="radio" name="pelaksanaan" id="modeOnline" value="online" 
                      <%= pelaksanaan === 'online' ? 'checked' : '' %> required>
                    <i class="bi bi-camera-video-fill pe-1 text-info"></i>
                    <span class="fs-5">Online</span>
                  </div>

                </div>
                <small id="msgRuangan" class="text-danger d-none fw-bold mt-1" style="font-size: 0.8rem;">*Ruangan penuh, silakan pilih Online</small>
              </div>
            </div>

            <div class="row mb-4">
              <div class="fw-bold">
                <label for="tempatDisplay" class="form-label fw-bold h3">Tempat / Link</label>
              </div>
              <div class="text-black-50">
                <span id="tempatDisplay"><%= tempat || '-' %></span>
              </div>
              <input type="hidden" name="tempat" id="tempatInput" value="<%= tempat || '' %>">
            </div>

<div class="d-flex align-items-center gap-2">
  <% if (locals.tanggal && locals.tanggal !== '') { %>
    <button type="button" id="btnHapusJadwal" class="btn btn-outline-danger d-flex align-items-center gap-2">
      <i class="bi bi-trash3-fill"></i> Hapus Jadwal
    </button>
  <% } %>

  <div class="ms-auto d-flex gap-2">
    <button type="button" id="btnReset" class="btn btn-outline-secondary d-flex align-items-center gap-2">
      <i class="bi bi-arrow-counterclockwise"></i> Reset
    </button>

    <%- include('../partials/button', { 
        buttonType: 'submit', 
        buttonLabel: 'Simpan', 
        buttonTarget: '/mahasiswa/isi-jadwal', 
        buttonStatus: '' 
    }) %>
  </div>
</div>

          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <%- include('../partials/button', { buttonType: 'back', buttonLabel: 'Kembali', buttonTarget: '/mahasiswa/dashboard', buttonStatus: '' }) %>
  </div>
</div>

<%- include('../partials/modal', {
    id: 'modalHapusJadwal', 
    type: 'hapusJadwal',
    title: 'Batalkan Jadwal?', 
    body: 'Apakah Anda yakin ingin menghapus jadwal ujian ini? Slot Anda akan menjadi kosong kembali.',
    catatan: '',
    src: ''
}) %>

      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const offline = document.getElementById("modeOffline");
  const online = document.getElementById("modeOnline");
  const tempatDisplay = document.getElementById("tempatDisplay");
  const tempatInput = document.getElementById("tempatInput");

  function updateTempat(value) {
    tempatDisplay.textContent = value;
    tempatInput.value = value;
  }

  offline.addEventListener("change", function () {
    if (this.checked) updateTempat("Ruang Sidang PSPPI, Gedung A FT Universitas Lampung");
  });
  online.addEventListener("change", function () {
    if (this.checked) updateTempat("Zoom Meeting");
  });

  // Inisialisasi awal saat load
  if (offline.checked) updateTempat("Ruang Sidang PSPPI, Gedung A FT Universitas Lampung");
  else if (online.checked) updateTempat("Zoom Meeting");
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // 1. AMBIL DATA DARI BACKEND KE JS
  // Pastikan Controller mengirim 'events' dan 'myDosenIds'
  const allEvents = <%- JSON.stringify(events) %>;
  const myDosenIds = <%- JSON.stringify(myDosenIds) %>; // Array ID Pembimbing User

  // 2. DOM Elements
  const inputTanggal = document.querySelector('input[name="tanggal"]');
  const inputWaktu = document.querySelector('input[name="jamMulai"]');
  const radioOffline = document.getElementById("modeOffline");
  const radioOnline = document.getElementById("modeOnline");
  const btnSimpan = document.querySelector('button[type="submit"]');
  const alertBox = document.getElementById("alertError");
  const msgRuangan = document.getElementById("msgRuangan");

  // Helper: Cek Irisan Array (Apakah Dosen A ada di Jadwal B?)
  function checkDosenConflict(eventDosenIds, myIds) {
    if (!eventDosenIds || !myIds) return false;
    // Mengembalikan true jika ada SATU saja ID yang sama
    return eventDosenIds.some(id => myIds.includes(id));
  }

  // 3. LOGIC VALIDASI UTAMA
  // Function ini dibuat global (window.validateSchedule) biar bisa dipanggil 
  // dari script external/calendar handler saat eventClick (Bajak Klik).
  window.validateSchedule = function() {
    const tgl = inputTanggal.value; // YYYY-MM-DD
    const jam = inputWaktu.value;   // HH:mm

    // Reset State Awal
    alertBox.classList.add('d-none');
    alertBox.innerText = "";
    msgRuangan.classList.add('d-none');
    radioOffline.disabled = false;
    btnSimpan.disabled = false;
    
    // Update Kalender View (Visual) - Trigger event buat kalender biar pindah tanggal
    if (tgl) {
        const event = new CustomEvent('updateCalendarDate', { detail: { date: tgl, time: jam } });
        document.dispatchEvent(event);
    }

    if (!tgl || !jam) return; // Jangan validasi kalau belum lengkap inputnya

// Filter Event di Jam yang Sama (Versi Anti-Error)
// -------------------------------------------------------------
    // LOGIC FILTER PINTAR (Bisa baca format FullCalendar & Database)
    // -------------------------------------------------------------
    const concurrentEvents = allEvents.filter(e => {
        let dbTanggal, dbJam;

        // KEMUNGKINAN 1: Data format Database (Sesuai Screenshot pgAdmin)
        // Kolom: tanggal & jam_mulai
        if (e.tanggal && e.jam_mulai) {
             // Handle jika tanggal masih berupa object Date dari database
             // Kita ambil string 10 digit pertama (YYYY-MM-DD)
             dbTanggal = (typeof e.tanggal === 'string') 
                ? e.tanggal.substring(0, 10) 
                : new Date(e.tanggal).toISOString().substring(0, 10);
             
             dbJam = e.jam_mulai;   // Contoh: "09:00:00"
        } 
        // KEMUNGKINAN 2: Data format FullCalendar (ISO String)
        // Properti: start ("2025-11-20T09:00:00")
        else if (e.start) {
             // Ganti 'T' jadi spasi jaga-jaga formatnya beda, lalu ambil jamnya
             const parts = e.start.replace('T', ' ').split(' ');
             dbTanggal = parts[0];
             dbJam = parts[1] || ''; 
        } 
        else {
             // Kalau data gak jelas, skip aja
             return false;
        }

        // --- NORMALISASI WAKTU ---
        // Ambil 5 digit depan aja (jam:menit) & pastikan pemisahnya titik dua
        // Ini biar "09:00:00" dari DB match sama "09:00" dari input user
        const dbJamClean = dbJam.substring(0, 5).replace('.', ':');
        const inputJamClean = jam.replace('.', ':');

        // Bandingkan Tanggal & Jam
        return dbTanggal === tgl && dbJamClean === inputJamClean;
    });

    // --- CEK 1: DOSBING BENTROK (PRIORITAS TERTINGGI) ---
// ... di dalam window.validateSchedule ...

    // A. CEK DOSEN BENTROK
    let isDosenBusy = false;
    
    concurrentEvents.forEach(evt => {
        // üî• FIX: JANGAN CEK JADWAL SENDIRI (SKIP)
        // Kalau jadwal itu punya saya (isMine == true), abaikan.
        if (evt.extendedProps.isMine) return; 

        // Cek conflict dosen (lanjutkan logic lama)
        if (evt.extendedProps && evt.extendedProps.dosenTerlibat) {
            if (checkDosenConflict(evt.extendedProps.dosenTerlibat, myDosenIds)) {
                isDosenBusy = true;
            }
        }
    });

    // ...

    if (isDosenBusy) {
        alertBox.innerText = "‚ùå GAGAL: Dosen Pembimbing Anda sedang menguji mahasiswa lain di jam ini.";
        alertBox.classList.remove('d-none');
        btnSimpan.disabled = true; // Matikan tombol simpan
        return; // Stop, gak usah cek ruangan kalau dosen udah sibuk
    }

    // --- CEK 2: RUANGAN OFFLINE PENUH ---
    const offlineExisting = concurrentEvents.filter(e => 
        e.extendedProps.pelaksanaan === 'offline'
    );

    if (offlineExisting.length > 0) {
        // Ada yang pake ruangan!
        radioOffline.disabled = true; // Disable pilihan Offline
        msgRuangan.classList.remove('d-none'); // Munculin pesan kecil
        
        // Kalo user terlanjur milih Offline, pindahin ke Online
        if (radioOffline.checked) {
            radioOnline.checked = true;
            // Trigger change event biar teks tempat berubah
            radioOnline.dispatchEvent(new Event('change'));
        }
    }
  };

  // 4. PASANG EVENT LISTENER
  inputTanggal.addEventListener('change', window.validateSchedule);
  inputWaktu.addEventListener('change', window.validateSchedule);
  
  // Validasi saat radio button diklik (opsional, buat double check)
  radioOffline.addEventListener('change', function() {
      if (this.disabled) {
          this.checked = false;
          radioOnline.checked = true;
      }
  });

});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    
    // 1. AMBIL ELEMEN (Pastikan ID-nya sesuai HTML)
    const formJadwal = document.getElementById('formJadwal');
    const btnReset = document.getElementById('btnReset');

    // ---------------------------------------------
    // FITUR RESET (Mengatasi Error addEventListener null)
    // ---------------------------------------------
    if (btnReset) {
        btnReset.addEventListener('click', function() {
            if(formJadwal) formJadwal.reset();
            // Reset tampilan tempat & radio button manual jika perlu
            document.getElementById('tempatDisplay').innerText = '-';
            document.getElementById('tempatInput').value = '';
        });
    } else {
        console.warn("‚ö†Ô∏è Button Reset (id='btnReset') tidak ditemukan di HTML, event listener dilewati.");
    }

    // ---------------------------------------------
    // FITUR SIMPAN (Mengatasi Error 400 Bad Request)
    // ---------------------------------------------
    if (formJadwal) {
        formJadwal.addEventListener('submit', async function(e) {
            e.preventDefault(); // Mencegah reload halaman
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            // --- LOGIC PERBAIKAN DATA ---
            const DURASI_MENIT = 60; 

            // Ambil input jam (Prioritas: jamMulai, cadangan: waktuUjian)
            let rawJam = data.jamMulai || data.waktuUjian;

            if (!rawJam) {
                Swal.fire('Gagal', 'Jam Mulai belum diisi!', 'error');
                return;
            }

            try {
                // 1. Normalisasi Jam (Ubah titik jadi titik dua, cth: 13.00 -> 13:00)
                rawJam = rawJam.replace('.', ':');
                let jamClean = rawJam.substring(0, 5); // Ambil HH:mm

                // 2. Hitung Jam Selesai
                let [jam, menit] = jamClean.split(':').map(Number);
                let dateObj = new Date();
                dateObj.setHours(jam);
                dateObj.setMinutes(menit + DURASI_MENIT);

                let jamSelesai = dateObj.getHours().toString().padStart(2, '0') + ':' + 
                                 dateObj.getMinutes().toString().padStart(2, '0');

                // 3. SIAPKAN DATA FINAL (PENTING BUAT DATABASE)
                // Pastikan key-nya 'jamMulai' dan 'jamSelesai' + detik :00
                data.jamMulai = jamClean + ":00";   
                data.jamSelesai = jamSelesai + ":00";
                
                // Hapus key lama jika masih ada biar ga nyampah
                if(data.waktuUjian) delete data.waktuUjian;

            } catch (err) {
                console.error("Format waktu error:", err);
                Swal.fire('Error', 'Format waktu tidak valid', 'error');
                return;
            }

            console.log("üì§ Mengirim Data:", data); // Cek Console browser kalo masih error

            // --- KIRIM KE BACKEND ---
            try {
                const response = await fetch('/mahasiswa/isi-jadwal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil!',
                        text: result.message
                    }).then(() => {
                        window.location.href = '/mahasiswa/isi-jadwal';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal Menyimpan',
                        text: result.message || 'Terjadi kesalahan validasi.'
                    });
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                Swal.fire('Error', 'Terjadi kesalahan koneksi ke server.', 'error');
            }
        });
    } else {
        console.error("‚ùå Form (id='formJadwal') TIDAK DITEMUKAN! Cek HTML kamu.");
    }
});
</script>

<script>
document.getElementById('btnHapusJadwal')?.addEventListener('click', function() {
    Swal.fire({
        title: 'Batalkan Jadwal?',
        text: "Apakah Anda yakin ingin menghapus jadwal ujian ini? Slot Anda akan menjadi kosong kembali.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Ya, Hapus!',
        cancelButtonText: 'Batal'
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                // Mengirim request dengan method DELETE
                const response = await fetch('/mahasiswa/isi-jadwal', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    Swal.fire('Terhapus!', data.message, 'success').then(() => {
                        window.location.reload(); // Reload untuk membersihkan tampilan
                    });
                } else {
                    Swal.fire('Gagal', data.message, 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'Terjadi kesalahan koneksi.', 'error');
            }
        }
    });
});
</script>